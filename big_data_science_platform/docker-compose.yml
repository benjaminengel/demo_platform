
version: '2'

services:
################################ 
# setting up the zookeper trio #
#### ###########################

  zk1:
    image: confluentinc/cp-zookeeper:latest
    hostname: zk1
    ports:
      - "22181:22181"
    environment:
      ZOOKEEPER_SERVER_ID: 1
      ZOOKEEPER_CLIENT_PORT: 22181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;zk3:42888:43888


  zk2:
    image: confluentinc/cp-zookeeper:latest
    hostname: zk2
    ports:
      - "32181:32181"
    environment:
      ZOOKEEPER_SERVER_ID: 2
      ZOOKEEPER_CLIENT_PORT: 32181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;2k3:42888:43888



  zk3:
    image: confluentinc/cp-zookeeper:latest
    hostname: zk3
    ports:
      - "42181:42181"
    environment:
      ZOOKEEPER_SERVER_ID: 3
      ZOOKEEPER_CLIENT_PORT: 42181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_INIT_LIMIT: 5
      ZOOKEEPER_SYNC_LIMIT: 2
      ZOOKEEPER_SERVERS: zk1:22888:23888;zk2:32888:33888;2k3:42888:43888


################################
# setting up the kafka cluster #
################################

  kafka1:
    image: confluentinc/cp-kafka:latest
    hostname: kafka1
    ports:
      - "19092:19092"
    depends_on:
      - zk1
      - zk2
      - zk3
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka1:19092

  kafka2:
    image: confluentinc/cp-kafka:latest
    hostname: kafka2
    ports:
      - "29092:29092"
    depends_on:
      - zk1
      - zk2
      - zk3
    environment:
      KAFKA_BROKER_ID: 2 
      KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka2:29092

  kafka3:
    image: confluentinc/cp-kafka:latest
    hostname: kafka3
    ports:
      - "39092:39092"
    depends_on:
      - zk1
      - zk2
      - zk3
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zk1:22181,zk2:32181,zk3:42181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka3:39092

#######################
# Analytics und Spark #
#######################

  jupyter_spark:
    image: jupyter/all-spark-notebook
    user: root
    #remove hostename due to problems of local spark instance
    #hostname: jupyter_spark
    ports:
      - "8888:8888"
      - "4040-4080:4040-4080"
    environment:
      NB_USER : 'jovyan'
      GRANT_SUDO : 'yes'
    volumes:
      - ./notebooks:/home/jovyan/notebooks/
      
#########
# Druid #
#########
#  druid:
#    image: druidio/example-cluster
##    hostname: druid
#    ports:
#      - 3000:8082 
#      - 3001:8081
            
############
# Mongo DB #
############
  mongo:
    image: mongo
    hostname: mongo
    ports:
      - "27017:27017"

##############
# H2O Server #
##############
  h2o:
    image: h2oai
    hostname: h2o
    ports:
       - "54321:54321"
    entrypoint: java -Xmx1g -jar /opt/h2o.jar

#####################
# Cassandra Cluster #
#####################
  cassandra-seed:
    container_name: cassandra-seed-node
    image: cassandra:3.11.0
    ports:
      - "9042:9042"   # Native transport
      - "7199:7199"   # JMX
      - "9160:9160"   # Thrift clients

  cassandra-node-1:
    image: cassandra:3.11.0
    command: /bin/bash -c "echo 'Waiting for seed node' && sleep 30 && /docker-entrypoint.sh cassandra -f"
    environment:
      - "CASSANDRA_SEEDS=cassandra-seed-node"
    depends_on:
      - "cassandra-seed"
      
# OOM wit 16GB of RAM
#  # you cannot have multiple nodes join the cluster at the same time when
#  # cassandra.consistent.rangemovement is true so we further delay it to give it time to stabilize
#  cassandra-node-2:
#    image: cassandra:3.11.0
#    command: /bin/bash -c "echo 'Waiting for seed node' && sleep 80 && /docker-entrypoint.sh cassandra -f"
#    environment:
#      - "CASSANDRA_SEEDS=cassandra-seed-node"
#    depends_on:
#      - "cassandra-seed"
